<!DOCTYPE html>
<html>
<head>
    <title>Sockets chat</title>
    <link href="styles.css" rel="stylesheet" type="text/css">
</head>
<body>
<h3>Users info</h3>
<ul id="users"></ul>
<h1>Messages</h1>
<ul id="messages"></ul>
<form id="form" action="">
    <input id="nickname" autocomplete="off" />
    <input id="input" autocomplete="off" /><button>Send</button>
</form>
<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();

    const messages = document.getElementById('messages');
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const nickname = document.getElementById('nickname');

    const users = document.getElementById('users');

    restoreMessagesFromCache(messages);

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value && nickname.value) {
            socket.emit('chat message', { message: input.value, name: nickname.value });
            input.value = '';
        }
        else if (!nickname.value)
        {
            alert("Enter name");
        }
        else if (!input.value)
        {
            alert("Enter message");
        }
    });

    socket.on('chat message', function(message) {
        const item = createMessageFromUser(message);
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);

        saveMessageToCache(message);
    });

    socket.on('connection', function () {
        const item = document.createElement('li');
        item.textContent = 'User connected!';
        users.appendChild(item);
    });

    socket.on('disconnected', function () {
        const item = document.createElement('li');
        item.textContent = 'User disconnected!';
        users.appendChild(item);
    });

    function getCachedMessages()
    {
        const cachedMessages = sessionStorage.getItem("cache");
        if (cachedMessages == null)
        {
            sessionStorage.setItem("cache", JSON.stringify([]));
            return [];
        }

        return JSON.parse(cachedMessages);
    }

    function saveMessageToCache(message)
    {
        const cachedMessages = getCachedMessages();
        cachedMessages.push(message);
        sessionStorage.setItem("cache", JSON.stringify(cachedMessages));
    }

    function createMessageFromUser(message)
    {
        const item = document.createElement('li');
        item.textContent = `${message.name}: ${message.message}`;
        return item;
    }

    function restoreMessagesFromCache(messages)
    {
        const cachedMessages = getCachedMessages();

        for (let i = 0; i < cachedMessages.length; i++) {
            const message = cachedMessages[i];
            const messageItem = createMessageFromUser(message);
            messages.appendChild(messageItem);
        }
    }
</script>
</body>
</html>